<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Map</title>
  <link rel="stylesheet" href="style.css">
  <script loading="async"
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu2UZd3M_rKwH70wjPPexlaprrTmdVBPQ&libraries=places"></script>
</head>

<script>
  let map;
  let service;
  let infowindow;

  function initialize() {
    let pyrmont = new google.maps.LatLng(25.753899, -80.377045);

    map = new google.maps.Map(document.getElementById('map'), {
      center: pyrmont,
      zoom: 15
    });

    // Autocomplete feature for the search box
    let input = document.getElementById('searchTextField');
    let autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);  // Fixed the method name

    // Marker declaration
    let marker = new google.maps.Marker({
      map: map,
      visible: false  // Initially hidden
    });

    google.maps.event.addListener(autocomplete, 'place_changed', () => {  // Corrected the event name
      let place = autocomplete.getPlace();

      if (!place.geometry) {
        console.log("Returned place contains no geometry");
        return;
      }

      if (place.geometry.viewport) {
        map.fitBounds(place.geometry.viewport);
      } else {
        map.setCenter(place.geometry.location);
        map.setZoom(17);
      }

      marker.setPosition(place.geometry.location);
      marker.setVisible(true);

      let request = {
        location: place.geometry.location,
        radius: '12000',
        type: ['cafe']
      };

      service = new google.maps.places.PlacesService(map);
      service.nearbySearch(request, callback);
    });
  }

  function callback(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      for (let i = 0; i < results.length; i++) {
        let place = results[i];
        createMarker(place);
        console.log(place);
      }
    }
  }

  function createMarker(place) {
    let marker = new google.maps.Marker({
      map: map,
      position: place.geometry.location
    });

    google.maps.event.addListener(marker, 'click', function () {
      alert(place.name);
      if (place.photos && place.photos.length > 0) {  // Ensure photos exist before using them
        window.open(place.photos[0].getUrl(), "_blank");
      } else {
        alert("No photos available");
      }
    });
  }

  // Correct event to load map when the page loads
  google.maps.event.addDomListener(window, 'load', initialize);
</script>

<body>
  <input id="searchTextField" type="text" size="50">
  <div id="map" style="height: 500px;"></div>
</body>
</html>
